<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassSync | GDG Hackathon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Google Sans', sans-serif; overflow-x: hidden; }
        .google-blue { color: #4285F4; }
        .google-red { color: #EA4335; }
        .google-yellow { color: #FBBC05; }
        .google-green { color: #34A853; }
        .bg-google-blue { background-color: #4285F4; }
        
        /* Modern UI Polish */
        .card-shadow { box-shadow: 0 1px 2px 0 rgba(60,64,67,0.30), 0 1px 3px 1px rgba(60,64,67,0.15); }
        .hover-lift { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s ease; }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(60,64,67,0.1); }
        
        /* Modal Animations */
        .modal-overlay { backdrop-filter: blur(8px); transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        .btn-transition { transition: all 0.2s ease; }
        .toast-enter { transform: translate(-50%, 100%); opacity: 0; }
        .toast-active { transform: translate(-50%, -20px); opacity: 1; }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #bdbdbd; }

        /* Section Badges */
        .badge-a { background: #E8F0FE; color: #1967D2; }
        .badge-b { background: #E6F4EA; color: #137333; }
        .badge-c { background: #FEF7E0; color: #B26A06; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <!-- Navigation Header -->
    <nav class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-50 transition-all">
        <div class="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3 cursor-pointer" id="navLogo">
                <span class="text-2xl font-bold tracking-tight">
                    <span class="google-blue">C</span><span class="google-red">l</span><span class="google-yellow">a</span><span class="google-blue">s</span><span class="google-green">s</span>Sync
                </span>
                <div class="h-6 w-[1px] bg-gray-200 hidden sm:block"></div>
                <span class="hidden sm:block text-[10px] font-bold text-gray-400 uppercase tracking-widest">MBU Campus</span>
            </div>
            
            <div class="flex items-center space-x-6">
                <div id="viewToggle" class="bg-gray-100 p-1 rounded-xl flex">
                    <button id="btnStudent" class="px-5 py-1.5 rounded-lg text-sm font-medium btn-transition bg-white shadow-sm text-google-blue">Student</button>
                    <button id="btnTeacher" class="px-5 py-1.5 rounded-lg text-sm font-medium btn-transition text-gray-600 hover:text-gray-900">Teacher</button>
                </div>
                <button id="logoutBtn" class="hidden flex items-center text-sm font-medium text-gray-500 hover:text-red-500 btn-transition">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-6 py-10">
        
        <!-- LOADING SPINNER -->
        <div id="loading" class="flex flex-col justify-center items-center py-32">
            <div class="animate-spin rounded-full h-10 w-10 border-[3px] border-gray-100 border-t-google-blue mb-4"></div>
            <p class="text-gray-400 text-sm font-medium animate-pulse">Syncing class data...</p>
        </div>

        <!-- TEACHER LOGIN -->
        <section id="loginView" class="hidden py-12">
            <div class="max-w-md mx-auto bg-white p-10 rounded-3xl border border-gray-100 card-shadow text-center">
                <div class="w-16 h-16 bg-blue-50 text-google-blue rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Teacher Portal</h2>
                <p class="text-gray-500 text-sm mb-8">Access your dashboard to manage recaps</p>
                <form id="loginForm" class="space-y-4 text-left">
                    <input type="text" id="loginUser" required placeholder="Username" class="w-full px-4 py-3 bg-gray-50 border border-transparent rounded-xl outline-none focus:bg-white focus:border-google-blue transition-all">
                    <input type="password" id="loginPass" required placeholder="Password" class="w-full px-4 py-3 bg-gray-50 border border-transparent rounded-xl outline-none focus:bg-white focus:border-google-blue transition-all">
                    <button type="submit" class="w-full bg-google-blue text-white py-3.5 rounded-xl font-bold hover:bg-blue-600 btn-transition shadow-lg shadow-blue-100">Sign In</button>
                </form>
                <div class="mt-8 p-4 bg-gray-50 rounded-xl text-xs text-gray-500">
                    <p class="font-bold uppercase tracking-wider mb-1 text-gray-400 text-center">Demo Account</p>
                    <p class="text-center"><code>admin</code> / <code>mbu123</code></p>
                </div>
            </div>
        </section>

        <!-- STUDENT VIEW -->
        <section id="studentView" class="hidden space-y-10">
            <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-6">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-3 tracking-tight">Today's Recap</h1>
                    <p class="text-gray-500 text-lg">Pick up where the lecture left off.</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <select id="sectionFilter" class="pl-4 pr-10 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-google-blue outline-none font-medium text-gray-600 btn-transition cursor-pointer">
                        <option value="all">All Sections</option>
                        <option value="Section A">Section A</option>
                        <option value="Section B">Section B</option>
                        <option value="Section C">Section C</option>
                    </select>
                    <div class="relative">
                        <input type="text" id="searchBox" placeholder="Search topics..." class="w-full sm:w-64 pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-google-blue outline-none">
                        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                </div>
            </div>

            <div id="summariesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            
            <div id="noData" class="hidden text-center py-24 bg-white rounded-3xl border border-dashed border-gray-200">
                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-300">
                     <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" /></svg>
                </div>
                <p class="text-gray-400 font-medium italic">No class summaries found for this view.</p>
            </div>
        </section>

        <!-- TEACHER DASHBOARD -->
        <section id="teacherView" class="hidden space-y-12">
            <div class="bg-white rounded-3xl border border-gray-100 p-8 card-shadow">
                <div class="flex items-center space-x-4 mb-10">
                    <div class="w-12 h-12 bg-blue-50 text-google-blue rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">New Class Entry</h1>
                        <p class="text-gray-500 text-sm">Post a recap for your students.</p>
                    </div>
                </div>

                <form id="uploadForm" class="grid grid-cols-1 md:grid-cols-6 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Subject</label>
                        <input type="text" id="subject" required placeholder="e.g. Algorithms" class="w-full px-4 py-3 bg-gray-50 border border-transparent rounded-xl focus:bg-white focus:border-google-blue outline-none transition-all">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Topic</label>
                        <input type="text" id="topic" required placeholder="e.g. Graph Traversal" class="w-full px-4 py-3 bg-gray-50 border border-transparent rounded-xl focus:bg-white focus:border-google-blue outline-none transition-all">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Target Section</label>
                        <select id="section" required class="w-full px-4 py-3 bg-gray-50 border border-transparent rounded-xl focus:bg-white focus:border-google-blue outline-none transition-all cursor-pointer">
                            <option value="Section A">Section A</option>
                            <option value="Section B">Section B</option>
                            <option value="Section C">Section C</option>
                        </select>
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Detailed Summary</label>
                        <textarea id="summary" required rows="6" placeholder="Break down the key points taught today..." class="w-full px-4 py-3 bg-gray-50 border border-transparent rounded-xl focus:bg-white focus:border-google-blue outline-none transition-all"></textarea>
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Resource URL (Optional)</label>
                        <input type="url" id="link" placeholder="https://..." class="w-full px-4 py-3 bg-gray-50 border border-transparent rounded-xl focus:bg-white focus:border-google-blue outline-none transition-all">
                    </div>
                    <div class="md:col-span-2 flex items-end">
                        <button type="submit" id="submitBtn" class="w-full bg-google-blue text-white font-bold py-3.5 rounded-xl hover:bg-blue-600 btn-transition shadow-lg shadow-blue-100">Publish Recap</button>
                    </div>
                </form>
            </div>

            <div class="pt-8">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 tracking-tight">Manage Published Recaps</h2>
                    <span id="postCount" class="bg-gray-100 text-gray-500 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-tighter">0 Total</span>
                </div>
                <div id="teacherSummaries" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </section>
    </main>

    <!-- DETAILED MODAL (For Students) -->
    <div id="detailsModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-6">
        <div class="fixed inset-0 bg-black/40 modal-overlay" id="modalOverlay"></div>
        <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col relative z-10 modal-content">
            <div class="p-8 border-b sticky top-0 bg-white">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center space-x-2 mb-2">
                            <span id="modalSubject" class="text-[10px] font-bold text-google-blue bg-blue-50 px-2 py-0.5 rounded-md uppercase tracking-widest"></span>
                            <span id="modalSection" class="text-[10px] font-bold text-google-green bg-green-50 px-2 py-0.5 rounded-md uppercase tracking-widest"></span>
                        </div>
                        <h2 id="modalTopic" class="text-3xl font-bold text-gray-900 tracking-tight leading-tight"></h2>
                    </div>
                    <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-50 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </button>
                </div>
            </div>
            <div class="p-8 overflow-y-auto flex-grow bg-white">
                <div class="prose max-w-none mb-8">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4">Class Brief</p>
                    <p id="modalSummary" class="text-gray-600 leading-relaxed whitespace-pre-line text-lg"></p>
                </div>
                <div id="modalAISection" class="hidden mt-8 p-6 bg-purple-50 rounded-2xl border border-purple-100">
                    <span class="block text-[10px] font-bold text-purple-400 uppercase tracking-[0.2em] mb-3 italic">AI Insight Recap</span>
                    <div id="modalAIContent" class="text-purple-900 leading-relaxed text-sm"></div>
                </div>
            </div>
            <div class="p-8 bg-gray-50 border-t flex flex-wrap gap-4 items-center">
                <a id="modalLink" href="#" target="_blank" class="hidden bg-google-blue text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-600 btn-transition shadow-lg shadow-blue-100 items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Resources
                </a>
                <button id="modalAIBtn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-purple-700 btn-transition shadow-lg shadow-purple-100 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/></svg>
                    Summarize with AI
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-10 left-1/2 z-[100] btn-transition toast-enter hidden">
        <div class="bg-gray-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center space-x-3">
            <span id="toastIcon">‚ú®</span>
            <span id="toastMsg" class="text-sm font-medium"></span>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVMBNUhCzfvVP5MxZX3ikiMTAiM7Rex6U", 
            authDomain: "classsync-01.firebaseapp.com",
            projectId: "classsync-01",
            storageBucket: "classsync-01.firebasestorage.app",
            messagingSenderId: "506437699662",
            appId: "1:506437699662:web:0f686c1e6229bc61251b1f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'class-sync-mbu-final-v3';
        const geminiKey = ""; 

        const TEACHER_USER = "admin";
        const TEACHER_PASS = "mbu123";

        let isTeacherLoggedIn = false;
        let allSummaries = [];

        // START AUTH
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } else {
                startListening();
            }
        });

        function startListening() {
            const path = collection(db, 'artifacts', appId, 'public', 'data', 'summaries');
            onSnapshot(path, (snapshot) => {
                allSummaries = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                allSummaries.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                render();
                document.getElementById('loading').classList.add('hidden');
                if (!isTeacherLoggedIn && document.getElementById('studentView').classList.contains('hidden')) {
                    switchView('student');
                }
            }, (err) => showToast("Database connection lost.", "‚ö†Ô∏è"));
        }

        // VIEW NAVIGATION
        function switchView(view) {
            const isStudent = view === 'student';
            const btnS = document.getElementById('btnStudent');
            const btnT = document.getElementById('btnTeacher');
            const viewS = document.getElementById('studentView');
            const viewT = document.getElementById('teacherView');
            const viewL = document.getElementById('loginView');

            btnS.className = `px-5 py-1.5 rounded-lg text-sm font-medium btn-transition ${isStudent ? 'bg-white shadow-sm text-google-blue' : 'text-gray-600 hover:text-gray-900'}`;
            btnT.className = `px-5 py-1.5 rounded-lg text-sm font-medium btn-transition ${!isStudent ? 'bg-white shadow-sm text-google-blue' : 'text-gray-600 hover:text-gray-900'}`;
            
            viewS.classList.toggle('hidden', !isStudent);
            
            if (isStudent) {
                viewT.classList.add('hidden');
                viewL.classList.add('hidden');
            } else {
                if (isTeacherLoggedIn) {
                    viewT.classList.remove('hidden');
                    viewL.classList.add('hidden');
                } else {
                    viewL.classList.remove('hidden');
                    viewT.classList.add('hidden');
                }
            }
        }

        function logout() {
            isTeacherLoggedIn = false;
            document.getElementById('logoutBtn').classList.add('hidden');
            showToast("Logged out successfully.");
            switchView('student');
        }

        // GLOBAL BINDINGS
        document.getElementById('btnStudent').onclick = () => switchView('student');
        document.getElementById('btnTeacher').onclick = () => switchView('teacher');
        document.getElementById('logoutBtn').onclick = logout;
        document.getElementById('navLogo').onclick = () => switchView('student');

        // FIXED DELETION LOGIC (MODERN EVENT DRIVEN)
        async function handleDelete(id) {
            if (!confirm("Remove this recap permanently?")) return;
            
            showToast("Deleting recap...", "üîÑ");
            try {
                // RULE 1 compliant path
                const noteRef = doc(db, 'artifacts', appId, 'public', 'data', 'summaries', id);
                await deleteDoc(noteRef);
                showToast("Recap removed.", "üóëÔ∏è");
            } catch (err) {
                console.error("Deletion failed:", err);
                showToast("Could not delete. Check permissions.", "‚ùå");
            }
        }

        // MODAL LOGIC
        function openDetails(id) {
            const data = allSummaries.find(s => s.id === id);
            if (!data) return;

            document.getElementById('modalTopic').innerText = data.topic;
            document.getElementById('modalSubject').innerText = data.subject;
            document.getElementById('modalSection').innerText = data.section;
            document.getElementById('modalSummary').innerText = data.summary;
            
            const linkBtn = document.getElementById('modalLink');
            if (data.link) {
                linkBtn.href = data.link;
                linkBtn.classList.remove('hidden', 'flex');
                linkBtn.classList.add('flex');
            } else {
                linkBtn.classList.add('hidden');
            }

            document.getElementById('modalAISection').classList.add('hidden');
            const aiBtn = document.getElementById('modalAIBtn');
            aiBtn.disabled = false;
            aiBtn.innerText = "Summarize with AI";
            aiBtn.onclick = () => runAI(id);

            document.getElementById('detailsModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        document.getElementById('closeModalBtn').onclick = closeDetailsModal;
        document.getElementById('modalOverlay').onclick = closeDetailsModal;

        // RENDER UI
        function render() {
            const term = document.getElementById('searchBox').value.toLowerCase();
            const filter = document.getElementById('sectionFilter').value;
            
            const filtered = allSummaries.filter(s => {
                const match = (s.subject || "").toLowerCase().includes(term) || (s.topic || "").toLowerCase().includes(term);
                return match && (filter === 'all' || s.section === filter);
            });

            // Student Feed
            const feed = document.getElementById('summariesContainer');
            feed.innerHTML = '';
            
            if (filtered.length === 0) {
                document.getElementById('noData').classList.remove('hidden');
            } else {
                document.getElementById('noData').classList.add('hidden');
                filtered.forEach(s => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-6 rounded-[2.2rem] border border-gray-100 card-shadow hover-lift cursor-pointer flex flex-col group";
                    
                    let sectionClass = "badge-a";
                    if(s.section === "Section B") sectionClass = "badge-b";
                    if(s.section === "Section C") sectionClass = "badge-c";

                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-[9px] font-bold text-google-blue bg-blue-50 px-2.5 py-1 rounded-lg uppercase tracking-widest">${s.subject}</span>
                                <span class="text-[9px] font-bold px-2.5 py-1 rounded-lg uppercase tracking-widest ${sectionClass}">${s.section?.split(' ')[1] || 'S'}</span>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-3 leading-tight group-hover:text-google-blue transition-colors">${s.topic}</h3>
                        <p class="text-gray-400 text-sm line-clamp-3 mb-6 leading-relaxed">${s.summary}</p>
                        <div class="mt-auto flex items-center justify-between pt-4 border-t border-gray-50">
                            <span class="text-[10px] text-gray-300 font-bold uppercase tracking-[0.2em]">Open Brief</span>
                            <svg class="w-4 h-4 text-google-blue transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 7l5 5m0 0l-5 5m5-5H6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </div>
                    `;
                    card.onclick = () => openDetails(s.id);
                    feed.appendChild(card);
                });
            }

            // Teacher Dashboard
            const dashboard = document.getElementById('teacherSummaries');
            dashboard.innerHTML = '';
            document.getElementById('postCount').innerText = `${allSummaries.length} Posts Total`;
            
            allSummaries.forEach(s => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-2xl border border-gray-100 flex items-center justify-between shadow-sm hover:border-google-blue transition-all";
                
                const info = document.createElement('div');
                info.className = "flex items-center space-x-4";
                info.innerHTML = `
                    <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center font-bold text-gray-400 text-xs">${s.section?.split(' ')[1] || 'S'}</div>
                    <div>
                        <h4 class="font-bold text-gray-900 text-sm leading-none mb-1">${s.topic}</h4>
                        <p class="text-[9px] text-gray-400 uppercase font-bold tracking-widest">${s.subject}</p>
                    </div>
                `;

                const delBtn = document.createElement('button');
                delBtn.className = "text-gray-300 hover:text-red-500 p-2 transition-colors";
                delBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                delBtn.onclick = () => handleDelete(s.id);

                card.appendChild(info);
                card.appendChild(delBtn);
                dashboard.appendChild(card);
            });
        }

        // GEMINI AI
        async function runAI(id) {
            const content = document.getElementById('modalAIContent');
            const section = document.getElementById('modalAISection');
            const btn = document.getElementById('modalAIBtn');
            
            section.classList.remove('hidden');
            content.innerHTML = '<span class="animate-pulse">‚ú® AI is drafting a quick brief...</span>';
            btn.disabled = true;
            btn.innerText = "Analyzing...";

            const data = allSummaries.find(s => s.id === id);
            const prompt = `Topic: ${data.topic}. Context: ${data.summary}. Generate a 3-point bulleted "Key Learnings" summary for a student. Use modern emojis. Extremely concise.`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const json = await res.json();
                content.innerText = json.candidates?.[0]?.content?.parts?.[0]?.text || "AI is temporarily unavailable. Try again in a bit.";
            } catch (e) {
                content.innerText = "Error: AI features require valid configuration.";
            } finally {
                btn.disabled = false;
                btn.innerText = "Summary Generated";
            }
        }

        // TOASTS
        function showToast(msg, icon = "‚ú®") {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastIcon').innerText = icon;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('toast-active'), 10);
            setTimeout(() => {
                t.classList.remove('toast-active');
                setTimeout(() => t.classList.add('hidden'), 300);
            }, 3000);
        }

        // FORMS
        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            if (u === TEACHER_USER && p === TEACHER_PASS) {
                isTeacherLoggedIn = true;
                document.getElementById('logoutBtn').classList.remove('hidden');
                showToast("Welcome back, Professor.", "üéì");
                switchView('teacher');
            } else showToast("Access Denied.", "‚ùå");
        };

        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "Publishing...";

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'summaries'), {
                    subject: document.getElementById('subject').value,
                    topic: document.getElementById('topic').value,
                    section: document.getElementById('section').value,
                    summary: document.getElementById('summary').value,
                    link: document.getElementById('link').value,
                    createdAt: serverTimestamp()
                });
                showToast("Class recap published!", "üöÄ");
                document.getElementById('uploadForm').reset();
            } catch (err) { showToast("Upload failed.", "‚ùå"); }
            finally { btn.disabled = false; btn.innerText = "Publish Recap"; }
        };

        document.getElementById('searchBox').oninput = render;
        document.getElementById('sectionFilter').onchange = render;
    </script>
</body>
</html>